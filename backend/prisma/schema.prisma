// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String    @id @default(uuid())
  email     String    @unique
  password  String
  role      Role      @default(USER)
  name      String?
  createdAt DateTime  @default(now())
  account   Account?
}

enum Role {
  ADMIN
  USER
}

enum AccountType {
  USER
  PLATFORM
}

enum LoanStatus {
  PENDING
  APPROVED
  ACTIVE
  CLOSED
}

enum DisbursementStatus {
  PENDING
  COMPLETED
  FAILED
  ROLLED_BACK
}

enum PaymentStatus {
  COMPLETED
  ROLLED_BACK
}

enum RepaymentScheduleStatus {
  PENDING
  PAID
  PARTIALLY_PAID
  ROLLED_BACK
}

enum TransactionType {
  DISBURSEMENT
  REPAYMENT
  ADDING_FUNDS
}

enum TransactionStatus {
  COMPLETED
}

enum LogLevel {
  DEBUG
  INFO
  WARN
  ERROR
}

enum OperationType {
  DISBURSEMENT
  REPAYMENT
  ROLLBACK
  MANUAL_ROLLBACK_DISBURSEMENT
  MANUAL_ROLLBACK_PAYMENT
}

enum AuditEventType {
  // Authentication & Authorization
  LOGIN_SUCCESS
  LOGIN_FAILED
  LOGOUT
  PASSWORD_CHANGE
  PASSWORD_RESET
  PERMISSION_DENIED
  
  // User Management
  USER_CREATED
  USER_UPDATED
  USER_DELETED
  ROLE_CHANGED
  
  // Loan Lifecycle
  LOAN_CREATED
  LOAN_APPROVED
  LOAN_REJECTED
  LOAN_DISBURSED
  LOAN_CLOSED
  LOAN_UPDATED
  
  // Disbursements
  DISBURSEMENT_INITIATED
  DISBURSEMENT_COMPLETED
  DISBURSEMENT_FAILED
  DISBURSEMENT_ROLLED_BACK
  
  // Payments
  PAYMENT_RECEIVED
  PAYMENT_PROCESSED
  PAYMENT_FAILED
  
  // Data Access
  SENSITIVE_DATA_VIEWED
  REPORT_GENERATED
  DATA_EXPORTED
  
  // System Events
  SYSTEM_ERROR
  CONFIG_CHANGED
}


model Account {
  id        String      @id @default(uuid())
  userId    String?     @unique @map("user_id")
  type      AccountType @default(USER)
  balance   Decimal     @db.Decimal(15, 2) @default(0)
  createdAt DateTime    @default(now()) @map("created_at")
  updatedAt DateTime    @updatedAt @map("updated_at")

  user User?  @relation(fields: [userId], references: [id])
  loans Loan[]

  @@map("accounts")
}

model Loan {
  id                   String              @id @default(uuid())
  accountId            String              @map("account_id")
  amount               Decimal             @db.Decimal(15, 2)
  interestRate         Decimal             @map("interest_rate") @db.Decimal(5, 2)
  tenor                Int
  status               LoanStatus
  outstandingPrincipal Decimal             @db.Decimal(15, 2) @default(0)
  createdAt            DateTime            @default(now()) @map("created_at")
  updatedAt            DateTime            @updatedAt @map("updated_at")

  account      Account             @relation(fields: [accountId], references: [id])
  disbursement Disbursement?
  schedules    RepaymentSchedule[]
  payments     Payment[]

  @@index([accountId])
  @@map("loans")
}

model Disbursement {
  id               String    @id @default(uuid())
  loanId           String    @unique @map("loan_id")
  amount           Decimal   @db.Decimal(15, 2)
  disbursementDate DateTime  @map("disbursement_date")
  status           DisbursementStatus
  rolledBackAt     DateTime? @map("rolled_back_at")
  createdAt        DateTime  @default(now()) @map("created_at")
  loan             Loan      @relation(fields: [loanId], references: [id])

  transaction Transaction? @relation(fields: [transactionId], references: [id])
  transactionId String?    @unique @map("transaction_id")

  @@map("disbursements")  
}

model RepaymentSchedule {
  id                String    @id @default(uuid())
  loanId            String    @map("loan_id")
  installmentNumber Int       @map("installment_number")
  dueDate           DateTime  @map("due_date") @db.Date
  principalAmount   Decimal   @map("principal_amount") @db.Decimal(15, 2)
  interestAmount    Decimal   @map("interest_amount") @db.Decimal(15, 2)
  status            RepaymentScheduleStatus
  paidDate          DateTime? @map("paid_date")
  createdAt         DateTime  @default(now()) @map("created_at")
  loan              Loan      @relation(fields: [loanId], references: [id])
  payments          Payment[]

  @@map("repayment_schedules")
}

model Payment {
  id                  String             @id @default(uuid())
  loanId              String             @map("loan_id")
  repaymentScheduleId String?            @map("repayment_schedule_id")
  transactionId       String?            @unique @map("transaction_id")
  amount              Decimal            @db.Decimal(15, 2)
  paymentDate         DateTime           @map("payment_date")
  principalPaid       Decimal            @map("principal_paid") @db.Decimal(15, 2)
  interestPaid        Decimal            @map("interest_paid") @db.Decimal(15, 2)
  lateFeePaid         Decimal            @default(0) @map("late_fee_paid") @db.Decimal(15, 2)
  daysLate            Int                @default(0) @map("days_late")
  status              PaymentStatus
  createdAt           DateTime           @default(now()) @map("created_at")
  loan                Loan               @relation(fields: [loanId], references: [id])
  repaymentSchedule   RepaymentSchedule? @relation(fields: [repaymentScheduleId], references: [id])
  transaction         Transaction?       @relation(fields: [transactionId], references: [id])

  @@index([loanId])
  @@index([paymentDate])
  @@map("payments")
}

model AuditLog {
  id            String   @id @default(uuid())
  timestamp     DateTime @default(now())
  
  // Who & Where (User Context)
  userId        String?  @map("user_id")
  userEmail     String?  @map("user_email")
  userRole      String?  @map("user_role")
  ipAddress     String?  @map("ip_address") @db.VarChar(45)  // IPv6 max length
  userAgent     String?  @map("user_agent") @db.VarChar(255)
  sessionId     String?  @map("session_id")
  
  // What (Event Details)
  eventType     AuditEventType? @map("event_type")  // Optional for backward compatibility
  action        String?         @db.VarChar(20)      // CREATE, READ, UPDATE, DELETE, EXECUTE
  resource      String?         @db.VarChar(50)      // Loan, Payment, User, etc.
  resourceId    String?         @map("resource_id")  // Specific resource ID
  
  // Changes (Before/After State)
  oldValues     Json?    @map("old_values")  // State before change
  newValues     Json?    @map("new_values")  // State after change
  
  // Context (Existing fields - keep for backward compatibility)
  transactionId String   @map("transaction_id")
  operation     String   @db.VarChar(50)
  service       String   @default("system") @db.VarChar(20)
  level         LogLevel @default(INFO)
  
  // Result
  success       Boolean  @default(true)
  errorMessage  String?  @map("error_message") @db.Text
  
  // Metadata
  metadata      Json?
  duration      Int?     // milliseconds
  createdAt     DateTime @default(now()) @map("created_at")  // Keep for backward compatibility

  @@index([userId])
  @@index([eventType])
  @@index([resource, resourceId])
  @@index([timestamp])
  @@index([transactionId])
  @@index([service])
  @@index([level])
  @@map("audit_logs")
}

model RollbackRecord {
  id                  String   @id @default(uuid())
  transactionId       String   @map("transaction_id")
  originalOperation   OperationType @map("original_operation")
  rollbackReason      String   @map("rollback_reason") @db.Text
  compensatingActions Json     @map("compensating_actions")
  rolledBackBy        String   @default("SYSTEM") @map("rolled_back_by")
  errorDetails        Json?    @map("error_details")
  createdAt           DateTime @default(now()) @map("created_at")

  @@index([transactionId])
  @@index([originalOperation])
  @@map("rollback_records")
}

model Transaction {
  id        String   @id @default(uuid())
  type      TransactionType
  refId     String?  
  amount    Decimal  @db.Decimal(15,2)
  status    TransactionStatus @default(COMPLETED)
  createdAt DateTime @default(now())

  disbursement Disbursement?
  payment      Payment?

  @@map("transactions")
}